# CM3588 + AX650N — Оптимизация PCIe

**[English](README.md)** | **[中文](README.zh.md)**

> Ускорение LLM inference на +50-100% для [M5Stack Module LLM (AI-8850)](https://docs.m5stack.com/en/guide/ai_accelerator/llm-8850/m5_llm_8850_software_install) на [FriendlyElec CM3588 NAS](https://wiki.friendlyelec.com/wiki/index.php/CM3588).

## Проблема

NPU AX650N (24 TOPS INT8), подключённый через M.2 на CM3588 NAS, выдаёт только **7-7.5 tok/s** при LLM inference (Qwen3-0.6B) вместо ожидаемых 12-13 tok/s. Причины:

1. **Аппаратное ограничение PCIe Gen2 x1** — CM3588 разводит только 1 линию к M.2 слоту (устройство поддерживает x2)
2. **IRQ на маленьком ядре** — все прерывания обрабатываются медленным Cortex-A55 @ 1.8 ГГц
3. **Динамическое масштабирование частоты** — CPU снижает частоту между вызовами inference

## Решение

Этот toolkit применяет две оптимизации, дающие **+50-100% прирост** (зависит от модели):

| | До | После |
|--|-----|-------|
| Скорость декода | 7.1-7.5 tok/s | **10-12 tok/s** |
| TTFT (prefill) | 488-578 мс | **391 мс** |
| Стабильность | Высокий разброс | Стабильно |

## Быстрый старт

```bash
git clone https://github.com/MasterVVK/cm3588-ax650n-pcie-tuning.git
cd cm3588-ax650n-pcie-tuning
sudo ./install.sh
```

Оптимизация сохраняется после перезагрузок через systemd service.

## Что делает

1. **Переносит IRQ AX650N на большое ядро** — с Cortex-A55 (CPU0) на Cortex-A76 (CPU4)
2. **Устанавливает performance governor** — фиксирует частоту больших ядер на 2.3 ГГц
3. **Автоопределение** PCIe адреса AX650N и топологии CPU
4. **Сохраняется после ребута** через systemd service

## Диагностика

```bash
sudo ax650n-diagnose.sh
```

Показывает: PCIe топологию, скорость/ширину линка, MaxPayload, привязку IRQ, governor CPU и рекомендации.

## Результаты бенчмарков

### LLM Inference

Скорость декода (tok/s) через AXCL runtime на CM3588 PCIe Gen2 x1:

| Модель | Квант. | По умолч. | Оптимиз. | Ускорение | Native (офиц.) |
|--------|--------|----------:|---------:|----------:|---------------:|
| MiniCPM4-0.5B | W8A16 | 6-11 | **15-20** | +100% | 36 |
| SmolLM2-360M | W8A16 | 5-10 | **13-16** | +75% | 38.7 |
| Qwen3-0.6B | W8A16 | 7.1-7.5 | **10-12** | +50% | 19-20 |
| DeepSeek-R1-1.5B | W4A16 | 4.8-7.0 | **10.2-11.0** | +75% | 17.7 |
| DeepSeek-R1-1.5B | W8A16 | 4.0-5.2 | **7.6-8.6** | +95% | 17.7 |
| Qwen3-1.7B | W8A16 | 5.1-5.3 | **7.8-8.0** | +50% | 7.42 |
| Qwen2.5-7B | W4A16 | 3.7 | **4.4** | +19% | 4.8 |
| SmolLM3-3B | W8A16 | 2.6-3.2 | **4.3-4.4** | +50% | — |
| Qwen3-4B | W8A16 | 2.6-2.8 | **3.7** | +37% | — |

TTFT (время до первого токена):

| Модель | По умолч. | Оптимиз. | Ускорение |
|--------|----------:|---------:|----------:|
| MiniCPM4-0.5B | 305-423 мс | **214-242 мс** | +40% |
| SmolLM2-360M | 348-530 мс | **259-304 мс** | +35% |
| Qwen3-0.6B | 488-578 мс | **391 мс** | +25% |
| DeepSeek-R1-1.5B | 503-688 мс | **380-432 мс** | +35% |
| Qwen3-1.7B | 541 мс | **447 мс** | +21% |
| SmolLM3-3B | 916-1043 мс | **708-735 мс** | +30% |
| Qwen3-4B | 1216 мс | **1110 мс** | +10% |

MiniCPM4-0.5B и SmolLM2-360M показывают наибольшее ускорение **+75-100%** — маленькие эффективные архитектуры максимально выигрывают от снижения PCIe задержки. Без оптимизации baseline крайне нестабилен (schedutil даёт разброс до 2x). DeepSeek-R1-1.5B W4A16 достигает **11 tok/s**, делая reasoning-модели практичными на edge-устройствах. Qwen3-1.7B достигает **~108% от native** (7.9 vs 7.42). **9 конфигураций LLM** из 7 семейств моделей.

### Vision модели (NPU inference, 640x640)

| Модель | По умолч. (мс) | Оптимизировано (мс) | Ускорение | FPS |
|--------|----------:|------------:|--------:|----:|
| YOLO11s | 3.99 | **3.55** | +12% | 282 |
| YOLOv8s | 4.21 | **3.89** | +8% | 257 |
| YOLO11s-Seg | 5.27 | **4.60** | +13% | 217 |
| YOLOv8s-Seg | 5.26 | **5.11** | +3% | 196 |
| YOLOv5s | 6.92 | **6.59** | +5% | 152 |
| YOLO26m | 9.47 | **9.04** | +5% | 111 |
| YOLOv5s-Seg | 10.08 | **9.86** | +2% | 101 |
| YOLOv8s-Pose | 11.81 | **11.26** | +5% | 89 |
| YOLO11x | 25.86 | **25.19** | +3% | 40 |
| YOLO11x-Pose | 25.65 | **25.55** | +0.4% | 39 |
| YOLO11x-Seg | 35.51 | **35.15** | +1% | 28 |
| Depth-Anything-V2-S | 34.00 | **33.44** | +2% | 30 |

### YOLO26 Pose Estimation & Segmentation (NPU 3 ядра, 640x640)

| Модель | По умолч. (мс) | Оптимиз. (мс) | Ускорение | FPS | Native (мс) |
|--------|----------:|------------:|--------:|----:|------------:|
| YOLO26n-Pose | 2.08 | **1.71** | **+22%** | 586 | 1.53 |
| YOLO26n-Seg | 2.86 | **2.34** | **+22%** | 428 | 1.97 |
| YOLO26s-Pose | 4.07 | **3.72** | +10% | 269 | 3.53 |
| YOLO26s-Seg | 5.61 | **5.04** | +12% | 199 | 4.70 |
| YOLO26m-Pose | 10.25 | **9.62** | +7% | 104 | 9.30 |
| YOLO26x-Pose | 26.38 | **25.71** | +3% | 39 | 25.13 |

YOLO26 nano: **+22%** — одни из лучших результатов для vision моделей. Полные n/s/m/l/x в [детальных бенчмарках](docs/benchmark-results.md).

### Depth-Anything-3

| Модель | По умолч. (мс) | Оптимиз. (мс) | Ускорение | Native (мс) |
|--------|----------:|------------:|--------:|------------:|
| DA3-small | 24.02 | **23.28** | +3% | 22.77 |
| DA3-base | 68.51 | **67.71** | +1% | 67.34 |

Ключевой эффект для vision: **2-22% быстрее + стабильность в 2-3 раза выше** (критично для realtime pipeline).

### Классификация (NPU inference, 224x224)

| Модель | По умолч. (мс) | Оптимизировано (мс) | Ускорение | FPS |
|--------|----------:|------------:|--------:|----:|
| MobileNetV2 | 0.983 | **0.657** | +50% | 1523 |
| SqueezeNet1.1 | 0.786 | **0.768** | +2% | 1302 |
| ResNet18 | 1.963 | **1.435** | +37% | 697 |
| ResNet50 | 3.613 | **3.355** | +8% | 298 |

### OCR — PPOCR_v5 (Детекция + Распознавание текста)

| Модель | Задача | По умолч. (мс) | Оптимиз. (мс) | Ускорение | Native (мс) |
|--------|--------|----------:|------------:|--------:|------------:|
| det_npu1 | Детекция текста | 29.38 | **28.98** | +1% | — |
| det_npu3 | Детекция текста | 18.41 | **17.75** | +4% | 16.8 |
| cls_npu1 | Направление текста | 0.759 | **0.445** | +71% | — |
| cls_npu3 | Направление текста | 0.429 | **0.351** | +18% | 0.17 |
| rec_npu1 | Распознавание текста | 3.958 | **3.681** | +8% | — |
| rec_npu3 | Распознавание текста | 2.104 | **1.719** | +18% | 1.4 |

npu3 — официальный вариант (все 3 ядра NPU).

### Распознавание текста на сцене — SATRN

| Модель | По умолч. (мс) | Оптимиз. (мс) | Ускорение | Native (мс) |
|--------|----------:|------------:|--------:|------------:|
| SATRN backbone+encoder | 7.43 | **7.35** | +1% | 6.09 |
| SATRN decoder | 2.17 | **1.58** | **+37%** | 1.38 |

### Распознавание лиц — Insightface

| Модель | Задача | По умолч. (мс) | Оптимизировано (мс) | Ускорение | FPS | Native (мс) |
|--------|--------|----------:|------------:|--------:|----:|------------:|
| det_10g | Детекция | 7.36 | **6.86** | +7% | 146 | 6.95 |
| genderage | Пол/Возраст | 0.479 | **0.357** | +34% | 2801 | 0.30 |
| w600k_r50 | Эмбеддинги | 4.27 | **3.72** | +15% | 269 | 3.99 |

### Стерео глубина, Видеосегментация, ID говорящего, Аудио, Анимация портретов

| Модель | Задача | По умолч. (мс) | Оптимизировано (мс) | Ускорение | Native (мс) |
|--------|--------|----------:|------------:|--------:|------------:|
| LivePortrait stitching | Аним. портр. | 0.311 | **0.198** | **+57%** | — |
| EdgeTAM prompt enc | Видеосегм. | 0.297 | **0.270** | +10% | 0.06 |
| EdgeTAM prompt mask | Видеосегм. | 0.765 | **0.732** | +4% | 0.46 |
| gtcrn | Шумоподавл. | 1.607 | **1.434** | +12% | — |
| 3D-Speaker ECAPA-TDNN | ID говорящ. | 4.006 | **3.889** | +3% | — |
| EdgeTAM mask decoder | Видеосегм. | 5.338 | **5.184** | +3% | 4.73 |
| 3D-Speaker Res2NetV2 | ID говорящ. | 5.534 | **5.459** | +1% | 5.09 |
| LivePortrait motion | Аним. портр. | 8.177 | **7.472** | +9% | — |
| LivePortrait feature | Аним. портр. | 20.36 | **19.87** | +3% | — |
| RAFT-stereo 256x640 | Стерео глуб. | 21.19 | **21.28** | ~0% | 20.9 |
| EdgeTAM image encoder | Видеосегм. | 23.88 | **23.73** | +1% | 22.35 |
| RAFT-stereo 384x1280 | Стерео глуб. | 112.55 | **112.40** | ~0% | — |
| IGEV++ (RTIGEV) | Стерео глуб. | 143.40 | **143.06** | ~0% | 139.80 |
| centerpoint | 3D LiDAR дет. | 92.92 | **92.26** | +0.7% | 88.3 |
| bevformer | 3D BEV дет. | 92.58 | **92.11** | +0.5% | 91.2 |
| MeloTTS decoder | TTS декодер | 92.6 | **92.0** | +0.7% | — |
| LivePortrait spade | Аним. портр. | 233.3 | **232.5** | +0.3% | — |
| mel_band_roformer | Разд. музыки | 426.3 | **425.6** | +0.2% | — |

### Трекинг, Сегментация, Ключевые точки, QR-детекция

| Модель | Задача | По умолч. (мс) | Оптимизировано (мс) | Ускорение | FPS |
|--------|--------|----------:|------------:|--------:|----:|
| QR YOLO26n | QR-детекция | 4.08 | **3.63** | +12% | 275 |
| QR YOLO11n | QR-детекция | 4.26 | **3.80** | +12% | 263 |
| MixFormerV2 | Трекинг | 10.75 | **10.42** | +3% | 96 |
| YOLOv7-Face | Детекция лиц | 12.93 | **12.66** | +2% | 79 |
| DeepLabv3Plus | Сем. сегментация | 13.83 | **13.24** | +4% | 76 |
| SuperPoint | Ключ. точки | 28.05 | **27.84** | +1% | 36 |
| DEIMv2 DINOv3-S | Детекция | 43.05 | **42.42** | +1% | 24 |

### Super-Resolution, Zero-Shot, Речь, Реставрация

| Модель | Задача | По умолч. (мс) | Оптимизировано (мс) | Ускорение | Native (мс) |
|--------|--------|----------:|------------:|--------:|------------:|
| Real-ESRGAN x4 | 64→256 апскейл | 15.85 | **15.66** | +1% | 15.0 |
| Real-ESRGAN x4 | 256→1024 апскейл | 476.2 | **475.4** | +0.2% | 440 |
| MobileSAM encoder | Сегментация | 51.52 | **50.92** | +1% | 49.5 |
| MobileSAM decoder | Сегментация | 10.59 | **10.35** | +2% | 9.93 |
| SigLIP2 vision | Zero-shot изобр. | 11.48 | **11.37** | +1% | 11.1 |
| SigLIP2 text | Zero-shot текст | 5.00 | **4.57** | +10% | 4.56 |
| RT-DETR | Детекция | 9.52 | **9.35** | +2% | — |
| YOLO-World | Детекция | 9.71 | **9.25** | +5% | — |
| Whisper-tiny enc | Речь в текст | 21.27 | **21.13** | +1% | — |
| Whisper-tiny dec | Речь в текст | 4.05 | **3.93** | +3% | — |
| Zipformer joiner | ASR | 0.664 | **0.344** | **+93%** | — |
| Zipformer decoder | ASR | 0.437 | **0.243** | **+80%** | — |
| Zipformer encoder | ASR | 3.602 | **3.018** | +19% | — |
| SenseVoice stream | ASR (5 языков) | 13.11 | **12.37** | +6% | — |
| SenseVoice full | ASR (5 языков) | 55.33 | **54.69** | +1% | — |
| MobileCLIP2-S0 | CLIP изображение | 8.63 | **8.49** | +2% | — |
| MobileCLIP2-S4 | CLIP изображение | 64.94 | **64.34** | +1% | 65.3 |
| LibCLIP cnclip vision | CLIP изобр. (CN) | 89.44 | **88.76** | +0.8% | 88.48 |
| LibCLIP cnclip text | CLIP текст (CN) | 5.04 | **4.58** | +10% | 4.58 |
| FG-CLIP image | CLIP изображение | 129.2 | **128.7** | +0.4% | 125.2 |
| FG-CLIP text | CLIP текст | 11.67 | **11.08** | +5% | 10.82 |
| jina-clip-v2 image | CLIP изображение | 597.2 | **596.2** | +0.2% | 592.2 |
| jina-clip-v2 text | CLIP текст | 15.31 | **14.86** | +3% | 15.48 |
| ESPCN x2 | Super-resolution | 22.71 | **22.41** | +1% | 22 |
| CLIP ViT-L/14 text | CLIP текст | 6.39 | **5.82** | +10% | — |
| CLIP ViT-L/14 image | CLIP изобр. | 71.11 | **70.28** | +1% | — |
| cnclip ViT-L/14 text | CLIP текст (CN) | 5.04 | **4.35** | +14% | — |
| cnclip ViT-L/14 vision | CLIP изобр. (CN) | 114.1 | **113.4** | +0.7% | — |
| SigLIP-so400m vision | Zero-shot изобр. | 168.9 | **168.2** | +0.5% | — |
| SigLIP-so400m text | Zero-shot текст | 23.51 | **22.88** | +3% | — |
| RMBG-1.4 | Удаление фона | 107.2 | **106.5** | +1% | — |
| CodeFormer | Реставрация лиц | 444.7 | **444.1** | +0.1% | — |
| DeOldify | Колоризация | 383.6 | **383.0** | +0.2% | — |
| EDSR baseline x2 | Super-resolution | 694.7 | **693.9** | +0.1% | — |

### TTS — CosyVoice3 (русский текст на NPU)

| Метрика | По умолч. | Оптимизировано | Ускорение |
|---------|----------:|---------:|--------:|
| TTFT | 125 мс | **108 мс** | +16% |
| LLM Decode | 13.9 tok/s | **16.3 tok/s** | +17% |
| RTF | 2.0-3.7x | **1.7-1.9x** | |

### Embedding / RAG

| Модель | По умолч. (мс) | Оптимиз. (мс) | Ускорение | Native (мс) |
|--------|----------:|------------:|--------:|------------:|
| bge-small-en-v1.5 | 35.25 | **34.74** | +1.5% | 32.4 |
| Qwen3-Embedding Layer (×28) | 2.03 | **1.80** | +12.5% | — |
| Qwen3-Embedding Post | 8.67 | **8.09** | +7% | — |

Qwen3-Embedding (28 слоёв, W8A16) — та же архитектура что Qwen3-0.6B LLM. Слои декодера: +12.5%, совпадает с паттерном LLM.

### VLM — SmolVLM2-256M и FastVLM-0.5B (покомпонентные тесты)

Нет AXCL aarch64 бинарника для end-to-end VLM; отдельные .axmodel компоненты через `axcl_run_model`:

| Модель | Компонент | По умолч. (мс) | Оптимиз. (мс) | Ускорение |
|--------|-----------|----------:|------------:|--------:|
| SmolVLM2-256M | Vision Encoder | 99.12 | **98.35** | +1% |
| SmolVLM2-256M | LLM Layer | 0.818 | **0.566** | **+45%** |
| SmolVLM2-256M | LLM Post | 1.980 | **1.639** | +21% |
| FastVLM-0.5B | Vision Encoder | 45.51 | **44.64** | +2% |
| FastVLM-0.5B | LLM Layer | 1.547 | **1.170** | **+32%** |
| FastVLM-0.5B | LLM Post | 7.538 | **7.043** | +7% |
| SmolVLM-256M | Vision Encoder | 99.26 | **98.58** | +1% |
| SmolVLM-256M | LLM Layer | 0.700 | **0.450** | **+56%** |
| SmolVLM-256M | LLM Post | 2.110 | **1.582** | +33% |
| InternVL2.5-1B | Vision Encoder | 357.8 | **357.0** | +0.2% |
| InternVL2.5-1B | LLM Layer | 1.648 | **1.020** | **+62%** |
| InternVL2.5-1B | LLM Post | 7.533 | **7.098** | +6% |
| InternVL3-1B | Vision Encoder | 365.9 | **365.0** | +0.2% |
| InternVL3-1B | LLM Layer | 1.758 | **1.139** | **+54%** |
| InternVL3-1B | LLM Post | 7.642 | **7.041** | +8% |
| Janus-Pro-1B | Vision Encoder | 143.8 | **143.0** | +0.5% |
| Janus-Pro-1B | LLM Layer | 3.924 | **3.354** | +15% |
| Janus-Pro-1B | LLM Post | 11.195 | **10.410** | +7% |

Слои VLM декодера: +15-62% — совпадает с паттерном LLM. Оценка decode: SmolVLM2 ~38→54, SmolVLM ~43→66, FastVLM ~22→29 (native: 34.8), InternVL2.5-1B ~21→32 (**совпадает с native**: 32), InternVL3-1B ~22→29, Janus-Pro-1B ~8→11 tok/s.

### Паттерн эффекта оптимизации

Ускорение обратно пропорционально времени inference — быстрые модели получают больший выигрыш:

| Время inference | Пример | Ускорение |
|:-:|:-:|:-:|
| ~0.20 мс | LivePortrait stitching | **+57%** |
| ~0.24 мс | Zipformer decoder | **+80%** |
| ~0.27 мс | EdgeTAM prompt encoder | **+10%** |
| ~0.3 мс | Insightface genderage | **+34%** |
| ~0.34 мс | Zipformer joiner | **+93%** |
| ~0.35 мс | PPOCR_v5 cls (npu3) | **+18%** |
| ~0.45 мс | SmolVLM-256M LLM layer | **+56%** |
| < 0.5 мс | OCR классификатор (npu1) | **+71%** |
| ~0.7 мс | MobileNetV2 | **+50%** |
| ~1.0 мс | InternVL2.5-1B LLM layer | **+62%** |
| ~1.6 мс | SATRN decoder | **+37%** |
| ~1.7 мс | PPOCR_v5 rec (npu3) | **+18%** |
| ~1.4 мс | ResNet18, gtcrn | **+12-37%** |
| ~3.0 мс | Zipformer encoder | +19% |
| ~3.6 мс | QR YOLO26n/YOLO11n | +12% |
| ~3.7 мс | Insightface w600k_r50 | +15% |
| ~4.0 мс | YOLOv8s детекция | +10% |
| ~5.0 мс | YOLOv8s-Seg | +4% |
| ~5.8 мс | CLIP ViT-L/14 text | +10% |
| ~7.5 мс | LivePortrait motion | +9% |
| ~10 мс | MixFormerV2/YOLOv5s-Seg | +2-3% |
| ~13 мс | DeepLabv3Plus | +4% |
| ~18 мс | PPOCR_v5 det (npu3) | +4% |
| ~20 мс | LivePortrait feature | +3% |
| ~25 мс | YOLO11x/YOLO11x-Pose | +0.4-3% |
| ~29 мс | OCR детектор | +1% |
| ~35 мс | YOLO11x-Seg | +1% |
| ~92 мс | centerpoint/bevformer/MeloTTS | +0.5-0.7% |
| ~107 мс | RMBG-1.4 | +1% |
| ~143 мс | IGEV++ стерео глубина | ~0% |
| ~233 мс | LivePortrait spade | +0.3% |
| ~445 мс | CodeFormer | +0.1% |
| ~358 мс | InternVL2.5-1B vision | +0.2% |
| ~498 мс | DeOldify artistic | +0.2% |
| ~694 мс | EDSR baseline x2 | +0.1% |

Это объясняется тем, что задержка PCIe round-trip (~0.3 мс) занимает большую долю общего времени у быстрых моделей.

Zipformer joiner (+93%) — абсолютный рекорд для single-inference. Слои VLM декодера: +32-62%. InternVL2.5-1B с оптимизацией **достигает native скорости** (32 tok/s).

**140+ моделей протестировано** в 29 категориях: LLM, VLM, детекция, оценка позы, сегментация (инстанс/семантическая), классификация, OCR, распознавание/реставрация лиц, super-resolution, zero-shot, CLIP, распознавание речи, TTS, оценка глубины, стерео глубина, видеосегментация, ID говорящего, шумоподавление, трекинг, ключевые точки, QR-детекция, удаление фона, колоризация, анимация портретов, 3D детекция и другие.

Подробнее: [результаты бенчмарков](docs/benchmark-results.md) и [анализ PCIe архитектуры](docs/pcie-analysis.md).

## Требования

- FriendlyElec CM3588 NAS (RK3588)
- AX650N M.2 модуль ([M5Stack Module LLM](https://docs.m5stack.com/en/guide/ai_accelerator/llm-8850/m5_llm_8850_software_install) или аналог)
- Установленный драйвер AXCL ([ax-llm](https://github.com/AXERA-TECH/ax-llm))
- Root-доступ

## Удаление

```bash
sudo ./uninstall.sh
```

## Ссылки

- [CM3588 Wiki](https://wiki.friendlyelec.com/wiki/index.php/CM3588) — документация FriendlyElec CM3588
- [M5Stack Module LLM](https://docs.m5stack.com/en/guide/ai_accelerator/llm-8850/m5_llm_8850_software_install) — документация M5Stack AI-8850 / AX650N
- [ax-llm](https://github.com/AXERA-TECH/ax-llm) — движок LLM inference от Axera
- [AXCL](https://github.com/AXERA-TECH/axcl) — Axera PCIe host SDK

## Лицензия

[MIT](LICENSE)
